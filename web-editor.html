<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Napominalochka Content Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f7f7fa; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 24px; }
    h1, h2 { color: #4a3c6e; }
    textarea, input, select { width: 100%; margin: 4px 0 12px 0; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    .section { margin-bottom: 32px; }
    .media-list { display: flex; flex-wrap: wrap; gap: 12px; }
    .media-item { background: #f0f0f7; border-radius: 6px; padding: 8px; width: 180px; }
    .media-item img, .media-item video { max-width: 100%; border-radius: 4px; }
    .battery { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .battery-bar { width: 120px; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; border: 1px solid #bbb; }
    .battery-level { height: 100%; background: linear-gradient(90deg, #ffb6c1, #b39ddb); transition: width 0.3s; }
    .btn { background: #6c63ff; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-right: 8px; }
    .btn:disabled { background: #aaa; }
    .export-group { margin-top: 24px; }
    .small { font-size: 0.9em; color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Napominalochka Content Editor</h1>
    <div class="section">
      <h2>Батарейка настроения</h2>
      <div class="battery">
        <div class="battery-bar"><div id="batteryLevel" class="battery-level"></div></div>
        <span id="batteryPercent">100%</span>
        <button class="btn" id="chargeBtn">Зарядить +2%</button>
      </div>
      <div class="small">Батарейка разряжается на 1% каждые 10 секунд. Зарядка +2% по кнопке.</div>
    </div>
    <div class="section">
      <h2>Фразы (AppTexts)</h2>
      <label>SECRET_CODE:<input id="secretCode" type="text"></label>
      <label>SECRET_MESSAGE:<textarea id="secretMessage" rows="3"></textarea></label>
      <label>LOVE_MESSAGES (по одному в строке):<textarea id="loveMessages" rows="6"></textarea></label>
      <label>JOKES (по одному в строке):<textarea id="jokes" rows="4"></textarea></label>
      <label>FACTS (по одному в строке):<textarea id="facts" rows="4"></textarea></label>
      <label>MISSIONS (формат: название|описание, по одному в строке):<textarea id="missions" rows="8"></textarea></label>
      <label>JOURNEY_CONTENT (формат: заголовок|содержание, по одному в строке):<textarea id="journeyContent" rows="8"></textarea></label>
    </div>
    <div class="section">
      <h2>Галерея (GalleryConfig)</h2>
      <input type="file" id="mediaInput" multiple accept="image/*,video/*">
      <div class="small">Загружайте фото и видео. После загрузки добавьте заголовок и описание к каждому.</div>
      <div id="mediaList" class="media-list"></div>
    </div>
    <div class="export-group">
      <button class="btn" id="exportAppTexts">Экспорт AppTexts.java</button>
      <button class="btn" id="exportGalleryConfig">Экспорт GalleryConfig.java</button>
      <button class="btn" id="downloadMedia">Скачать все медиа (zip)</button>
      <button class="btn" id="clearAll">Очистить всё</button>
    </div>
    <div class="small" style="margin-top:16px;">Все данные сохраняются в браузере (LocalStorage) и не теряются при закрытии страницы.</div>
  </div>
  <script>
// ========== ПЕРЕМЕННЫЕ ===========
const LS_KEY = 'napominalochka_editor_data_v1';
let state = {
  battery: 100,
  batteryLastUpdate: Date.now(),
  secretCode: '',
  secretMessage: '',
  loveMessages: [],
  jokes: [],
  facts: [],
  missions: [],
  journeyContent: [],
  media: [] // {type, file, name, title, desc, url}
};
let batteryTimer = null;
let chargeCooldown = false;

// ========== ЗАГРУЗКА/СОХРАНЕНИЕ ===========
function saveState() {
  const toSave = {...state};
  toSave.media = toSave.media.map(m => ({...m, file: undefined, url: m.url})); // не сохраняем file-объекты
  localStorage.setItem(LS_KEY, JSON.stringify(toSave));
}
function loadState() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return;
  try {
    const loaded = JSON.parse(raw);
    Object.assign(state, loaded);
    // media url восстановить
    if (Array.isArray(loaded.media)) {
      state.media = loaded.media.map(m => ({...m, file: undefined, url: m.url}));
    }
  } catch(e) { console.error('Ошибка загрузки state', e); }
}

// ========== UI ОБНОВЛЕНИЕ ===========
function updateUI() {
  document.getElementById('secretCode').value = state.secretCode;
  document.getElementById('secretMessage').value = state.secretMessage;
  document.getElementById('loveMessages').value = state.loveMessages.join('\n');
  document.getElementById('jokes').value = state.jokes.join('\n');
  document.getElementById('facts').value = state.facts.join('\n');
  document.getElementById('missions').value = state.missions.map(m => m.join('|')).join('\n');
  document.getElementById('journeyContent').value = state.journeyContent.map(j => j.join('|')).join('\n');
  updateMediaList();
  updateBattery();
}

// ========== ОБРАБОТЧИКИ ИНПУТОВ ===========
function setupInputs() {
  document.getElementById('secretCode').oninput = e => { state.secretCode = e.target.value; saveState(); };
  document.getElementById('secretMessage').oninput = e => { state.secretMessage = e.target.value; saveState(); };
  document.getElementById('loveMessages').oninput = e => {
    state.loveMessages = e.target.value.split(/\n/).map(s=>s.trim()).filter(Boolean); saveState(); };
  document.getElementById('jokes').oninput = e => {
    state.jokes = e.target.value.split(/\n/).map(s=>s.trim()).filter(Boolean); saveState(); };
  document.getElementById('facts').oninput = e => {
    state.facts = e.target.value.split(/\n/).map(s=>s.trim()).filter(Boolean); saveState(); };
  document.getElementById('missions').oninput = e => {
    state.missions = e.target.value.split(/\n/).map(s=>s.split('|').map(x=>x.trim())).filter(arr=>arr.length===2); saveState(); };
  document.getElementById('journeyContent').oninput = e => {
    state.journeyContent = e.target.value.split(/\n/).map(s=>s.split('|').map(x=>x.trim())).filter(arr=>arr.length===2); saveState(); };
}

// ========== МЕДИА ===========
function updateMediaList() {
  const list = document.getElementById('mediaList');
  list.innerHTML = '';
  state.media.forEach((m, idx) => {
    const div = document.createElement('div');
    div.className = 'media-item';
    let preview = '';
    if (m.type === 'photo') preview = `<img src="${m.url}" alt="img">`;
    else preview = `<video src="${m.url}" controls height="80"></video>`;
    div.innerHTML = preview +
      `<input type="text" placeholder="Заголовок" value="${m.title||''}" onchange="window._mediaTitle(${idx}, this.value)">`+
      `<textarea rows="2" placeholder="Описание" onchange="window._mediaDesc(${idx}, this.value)">${m.desc||''}</textarea>`+
      `<button onclick="window._mediaDelete(${idx})">Удалить</button>`;
    list.appendChild(div);
  });
}
window._mediaTitle = (idx, val) => { state.media[idx].title = val; saveState(); };
window._mediaDesc = (idx, val) => { state.media[idx].desc = val; saveState(); };
window._mediaDelete = idx => { state.media.splice(idx,1); saveState(); updateMediaList(); };

document.getElementById('mediaInput').onchange = async function(e) {
  const files = Array.from(e.target.files);
  for (const file of files) {
    const type = file.type.startsWith('image') ? 'photo' : 'video';
    const url = URL.createObjectURL(file);
    state.media.push({type, file, name: '', title: '', desc: '', url});
  }
  saveState();
  updateMediaList();
  e.target.value = '';
};

// ========== БАТАРЕЙКА ===========
function updateBattery() {
  let percent = Math.max(0, Math.min(100, Math.round(state.battery)));
  document.getElementById('batteryLevel').style.width = percent + '%';
  document.getElementById('batteryPercent').textContent = percent + '%';
}
function batteryTick() {
  const now = Date.now();
  let diff = Math.floor((now - state.batteryLastUpdate)/10000); // 10 сек
  if (diff > 0) {
    state.battery = Math.max(0, state.battery - diff);
    state.batteryLastUpdate += diff*10000;
    saveState();
    updateBattery();
  }
}
function startBatteryTimer() {
  if (batteryTimer) clearInterval(batteryTimer);
  batteryTimer = setInterval(batteryTick, 2000);
}
document.getElementById('chargeBtn').onclick = function() {
  if (chargeCooldown) return;
  state.battery = Math.min(100, state.battery + 2);
  state.batteryLastUpdate = Date.now();
  saveState();
  updateBattery();
  chargeCooldown = true;
  document.getElementById('chargeBtn').disabled = true;
  setTimeout(()=>{
    chargeCooldown = false;
    document.getElementById('chargeBtn').disabled = false;
  }, 2000);
};

// ========== ЭКСПОРТ ===========
function escapeJavaString(str) {
  return str.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n');
}
function exportAppTexts() {
  let out = 'package com.napominalochka.app.config;\n\npublic class AppTexts {\n';
  out += `    public static final String SECRET_CODE = "${escapeJavaString(state.secretCode)}";\n`;
  out += `    public static final String[] LOVE_MESSAGES = {\n`;
  out += state.loveMessages.map(s=>`        "${escapeJavaString(s)}"`).join(',\n')+'\n    };\n';
  out += `    public static final String[][] MISSIONS = {\n`;
  out += state.missions.map(m=>`        {"${escapeJavaString(m[0])}", "${escapeJavaString(m[1])}"}`).join(',\n')+'\n    };\n';
  out += `    public static final String[][] JOURNEY_CONTENT = {\n`;
  out += state.journeyContent.map(j=>`        {"${escapeJavaString(j[0])}", "${escapeJavaString(j[1])}"}`).join(',\n')+'\n    };\n';
  out += `    public static final String[] JOKES = {\n`;
  out += state.jokes.map(s=>`        "${escapeJavaString(s)}"`).join(',\n')+'\n    };\n';
  out += `    public static final String[] FACTS = {\n`;
  out += state.facts.map(s=>`        "${escapeJavaString(s)}"`).join(',\n')+'\n    };\n';
  out += `    public static final String SECRET_MESSAGE = \n        "${escapeJavaString(state.secretMessage)}";\n`;
  out += '}\n';
  downloadTextFile('AppTexts.java', out);
}
function exportGalleryConfig() {
  let out = 'package com.napominalochka.app.config;\n\npublic class GalleryConfig {\n';
  out += '    public static final String[][] GALLERY_ITEMS = {\n';
  let idxPhoto = 1, idxVideo = 1;
  out += state.media.map(m => {
    let fname = '';
    if (m.type === 'photo') fname = `photo${idxPhoto++}.jpg`;
    else fname = `video${idxVideo++}`;
    return `        {"${m.type}", "${fname}", "${escapeJavaString(m.title||'')}", "${escapeJavaString(m.desc||'')}"}`;
  }).join(',\n')+'\n    };\n';
  out += '}\n';
  downloadTextFile('GalleryConfig.java', out);
}
function downloadTextFile(filename, text) {
  const blob = new Blob([text], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

// ========== СКАЧАТЬ МЕДИА ===========
document.getElementById('downloadMedia').onclick = async function() {
  const zip = await createZip();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(zip);
  a.download = 'media.zip';
  a.click();
};
async function createZip() {
  // Используем JSZip через CDN
  if (!window.JSZip) {
    await new Promise(r => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
      s.onload = r;
      document.body.appendChild(s);
    });
  }
  const zip = new JSZip();
  let idxPhoto = 1, idxVideo = 1;
  for (const m of state.media) {
    let fname = '';
    if (m.type === 'photo') fname = `photo${idxPhoto++}.jpg`;
    else fname = `video${idxVideo++}`;
    const res = await fetch(m.url);
    const blob = await res.blob();
    zip.file(fname, blob);
  }
  return zip.generateAsync({type:'blob'});
}

// ========== КНОПКИ ===========
document.getElementById('exportAppTexts').onclick = exportAppTexts;
document.getElementById('exportGalleryConfig').onclick = exportGalleryConfig;
document.getElementById('clearAll').onclick = function() {
  if (confirm('Очистить все данные?')) {
    localStorage.removeItem(LS_KEY);
    location.reload();
  }
};

// ========== ИНИЦИАЛИЗАЦИЯ ===========
loadState();
setupInputs();
updateUI();
startBatteryTimer();
setInterval(updateUI, 2000); // обновлять UI периодически

  </script>
</body>
</html>